variables :
  FMK_NEXUS: fmk.nexus-ci.onefiserv.net/apm/0006528
  BASE_DIR: "web/modules/custom"

default:
  tags:
    - apimhub-shell

  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - node_modules/

  artifacts :
    paths:
      - dist

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH


stages:
  - prepare
  - image
  - prepare-cert
  - image-cert
  - prepare-prod
  - image-prod

prepare_source_code_develop:
  stage: prepare
  only:
    - develop
  script:
    - echo "Downloading fiserv_admin_portal_app/js/admin_uiapp_bundle.js into fiserv_admin_portal_app module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer-dev/prep/cdn/admin_uiapp_bundle.js" -o "$BASE_DIR/fiserv_admin_portal_app/js/admin_uiapp_bundle.js"
    - echo "Downloading fiserv_audit_log/js/audit_log_bundle.js into fiserv_audit_log module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer-dev/prep/cdn/audit_log_bundle.js" -o "$BASE_DIR/fiserv_audit_log/js/audit_log_bundle.js"
    - echo "Downloading fiserv_ci_ui_tool_app/js/ci_ui_tool_bundle.js into fiserv_ci_ui_tool_app module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer-dev/prep/cdn/ci_ui_tool_bundle.js" -o "$BASE_DIR/fiserv_ci_ui_tool_app/js/ci_ui_tool_bundle.js"
    - echo "Downloading fiserv_cicd_app/js/cicd_uiapp_bundle.js into fiserv_cicd_app module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer-dev/prep/cdn/cicd_uiapp_bundle.js" -o "$BASE_DIR/fiserv_cicd_app/js/cicd_uiapp_bundle.js"
    - echo "Downloading fiserv_general_pages/js/apihub_general.js into fiserv_general_pages module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer-dev/prep/cdn/apihub_general.js" -o "$BASE_DIR/fiserv_general_pages/js/apihub_general.js"
    - echo "Downloading fiserv_general_pages/js/apihub_landing.js into fiserv_general_pages module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer-dev/prep/cdn/apihub_landing.js" -o "$BASE_DIR/fiserv_general_pages/js/apihub_landing.js"
    - echo "Downloading fiserv_landing_page/js/apihub_landing.js into fiserv_landing_page module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer-dev/prep/cdn/apihub_landing.js" -o "$BASE_DIR/fiserv_landing_page/js/apihub_landing.js"
    - echo "Downloading fiserv_monetization_app/js/monetization.js into fiserv_monetization_app module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer-dev/prep/cdn/monetization.js" -o "$BASE_DIR/fiserv_monetization_app/js/monetization.js"
    - echo "Downloading fiserv_product_management_app/js/fiserv-admin-ui-product-app.js into fiserv_product_management_app module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer-dev/prep/cdn/fiserv-admin-ui-product-app.js" -o "$BASE_DIR/fiserv_product_management_app/js/fiserv-admin-ui-product-app.js"
    - echo "Downloading fiserv_proxy_trace/js/proxy_trace_bundle.js into fiserv_proxy_trace module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer-dev/prep/cdn/proxy_trace_bundle.js" -o "$BASE_DIR/fiserv_proxy_trace/js/proxy_trace_bundle.js"
    - echo "Downloading fiserv_cicd_app/js/config_admin_tool_bundle.js into fiserv_cicd_app module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer-dev/prep/cdn/config_admin_tool_bundle.js" -o "$BASE_DIR/fiserv_cicd_app/js/config_admin_tool_bundle.js"
  artifacts:
    paths: 
      - web/modules/custom/
    expire_in: 1 hour

prepare_source_code_test:
  stage: prepare
  only:
    - test
  script:
    - echo "Downloading fiserv_admin_portal_app/js/admin_uiapp_bundle.js into fiserv_admin_portal_app module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/admin_uiapp_bundle.js" -o "$BASE_DIR/fiserv_admin_portal_app/js/admin_uiapp_bundle.js"
    - echo "Downloading fiserv_audit_log/js/audit_log_bundle.js into fiserv_audit_log module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/audit_log_bundle.js" -o "$BASE_DIR/fiserv_audit_log/js/audit_log_bundle.js"
    - echo "Downloading fiserv_ci_ui_tool_app/js/ci_ui_tool_bundle.js into fiserv_ci_ui_tool_app module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/ci_ui_tool_bundle.js" -o "$BASE_DIR/fiserv_ci_ui_tool_app/js/ci_ui_tool_bundle.js"
    - echo "Downloading fiserv_cicd_app/js/cicd_uiapp_bundle.js into fiserv_cicd_app module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/cicd_uiapp_bundle.js" -o "$BASE_DIR/fiserv_cicd_app/js/cicd_uiapp_bundle.js"
    - echo "Downloading fiserv_general_pages/js/apihub_general.js into fiserv_general_pages module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/apihub_general.js" -o "$BASE_DIR/fiserv_general_pages/js/apihub_general.js"
    - echo "Downloading fiserv_general_pages/js/apihub_landing.js into fiserv_general_pages module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/apihub_landing.js" -o "$BASE_DIR/fiserv_general_pages/js/apihub_landing.js"
    - echo "Downloading fiserv_landing_page/js/apihub_landing.js into fiserv_landing_page module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/apihub_landing.js" -o "$BASE_DIR/fiserv_landing_page/js/apihub_landing.js"
    - echo "Downloading fiserv_monetization_app/js/monetization.js into fiserv_monetization_app module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/monetization.js" -o "$BASE_DIR/fiserv_monetization_app/js/monetization.js"
    - echo "Downloading fiserv_product_management_app/js/fiserv-admin-ui-product-app.js into fiserv_product_management_app module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/fiserv-admin-ui-product-app.js" -o "$BASE_DIR/fiserv_product_management_app/js/fiserv-admin-ui-product-app.js"
    - echo "Downloading fiserv_proxy_trace/js/proxy_trace_bundle.js into fiserv_proxy_trace module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/proxy_trace_bundle.js" -o "$BASE_DIR/fiserv_proxy_trace/js/proxy_trace_bundle.js"
    - echo "Downloading fiserv_cicd_app/js/config_admin_tool_bundle.js into fiserv_cicd_app module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/config_admin_tool_bundle.js" -o "$BASE_DIR/fiserv_cicd_app/js/config_admin_tool_bundle.js"
    - echo "Downloading testing_tool_integration/testing_tool/static into testing_tool_integration module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/static.zip" -o "$BASE_DIR/testing_tool_integration/testing_tool/static.zip"
    - unzip -o "$BASE_DIR/testing_tool_integration/testing_tool/static.zip" -d "$BASE_DIR/testing_tool_integration/testing_tool/"
    - rm "$BASE_DIR/testing_tool_integration/testing_tool/static.zip"
  artifacts:
    paths: 
      - web/modules/custom/
    expire_in: 1 hour

prepare_source_code_cert:
  stage: prepare-cert
  only:
    - release
  script:
    - echo "Downloading fiserv_admin_portal_app/js/admin_uiapp_bundle.js into fiserv_admin_portal_app module"
    - curl -L --fail "https://apihub-cert.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-cert/prep/cdn/admin_uiapp_bundle.js" -o "$BASE_DIR/fiserv_admin_portal_app/js/admin_uiapp_bundle.js"
    - echo "Downloading fiserv_audit_log/js/audit_log_bundle.js into fiserv_audit_log module"
    - curl -L --fail "https://apihub-cert.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-cert/prep/cdn/audit_log_bundle.js" -o "$BASE_DIR/fiserv_audit_log/js/audit_log_bundle.js"
    - echo "Downloading fiserv_ci_ui_tool_app/js/ci_ui_tool_bundle.js into fiserv_ci_ui_tool_app module"
    - curl -L --fail "https://apihub-cert.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-cert/prep/cdn/ci_ui_tool_bundle.js" -o "$BASE_DIR/fiserv_ci_ui_tool_app/js/ci_ui_tool_bundle.js"
    - echo "Downloading fiserv_cicd_app/js/cicd_uiapp_bundle.js into fiserv_cicd_app module"
    - curl -L --fail "https://apihub-cert.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-cert/prep/cdn/cicd_uiapp_bundle.js" -o "$BASE_DIR/fiserv_cicd_app/js/cicd_uiapp_bundle.js"
    - echo "Downloading fiserv_general_pages/js/apihub_general.js into fiserv_general_pages module"
    - curl -L --fail "https://apihub-cert.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-cert/prep/cdn/apihub_general.js" -o "$BASE_DIR/fiserv_general_pages/js/apihub_general.js"
    - echo "Downloading fiserv_general_pages/js/apihub_landing.js into fiserv_general_pages module"
    - curl -L --fail "https://apihub-cert.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-cert/prep/cdn/apihub_landing.js" -o "$BASE_DIR/fiserv_general_pages/js/apihub_landing.js"
    - echo "Downloading fiserv_landing_page/js/apihub_landing.js into fiserv_landing_page module"
    - curl -L --fail "https://apihub-cert.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-cert/prep/cdn/apihub_landing.js" -o "$BASE_DIR/fiserv_landing_page/js/apihub_landing.js"
    - echo "Downloading fiserv_monetization_app/js/monetization.js into fiserv_monetization_app module"
    - curl -L --fail "https://apihub-cert.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-cert/prep/cdn/monetization.js" -o "$BASE_DIR/fiserv_monetization_app/js/monetization.js"
    - echo "Downloading fiserv_product_management_app/js/fiserv-admin-ui-product-app.js into fiserv_product_management_app module"
    - curl -L --fail "https://apihub-cert.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-cert/prep/cdn/fiserv-admin-ui-product-app.js" -o "$BASE_DIR/fiserv_product_management_app/js/fiserv-admin-ui-product-app.js"
    - echo "Downloading fiserv_proxy_trace/js/proxy_trace_bundle.js into fiserv_proxy_trace module"
    - curl -L --fail "https://apihub-cert.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-cert/prep/cdn/proxy_trace_bundle.js" -o "$BASE_DIR/fiserv_proxy_trace/js/proxy_trace_bundle.js"
    - echo "Downloading fiserv_cicd_app/js/config_admin_tool_bundle.js into fiserv_cicd_app module"
    - curl -L --fail "https://apihub-cert.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-cert/prep/cdn/config_admin_tool_bundle.js" -o "$BASE_DIR/fiserv_cicd_app/js/config_admin_tool_bundle.js"
    - echo "Downloading testing_tool_integration/testing_tool/static into testing_tool_integration module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/static.zip" -o "$BASE_DIR/testing_tool_integration/testing_tool/static.zip"
    - unzip -o "$BASE_DIR/testing_tool_integration/testing_tool/static.zip" -d "$BASE_DIR/testing_tool_integration/testing_tool/"
    - rm "$BASE_DIR/testing_tool_integration/testing_tool/static.zip"

  artifacts:
    paths: 
      - web/modules/custom/
    expire_in: 1 hour

prepare_source_code_prod:
  stage: prepare-prod
  only:
    - release
  script:
    - echo "Downloading fiserv_admin_portal_app/js/admin_uiapp_bundle.js into fiserv_admin_portal_app module"
    - curl -L --fail "https://apihub.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-prod/prep/cdn/admin_uiapp_bundle.js" -o "$BASE_DIR/fiserv_admin_portal_app/js/admin_uiapp_bundle.js"
    - echo "Downloading fiserv_audit_log/js/audit_log_bundle.js into fiserv_audit_log module"
    - curl -L --fail "https://apihub.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-prod/prep/cdn/audit_log_bundle.js" -o "$BASE_DIR/fiserv_audit_log/js/audit_log_bundle.js"
    - echo "Downloading fiserv_ci_ui_tool_app/js/ci_ui_tool_bundle.js into fiserv_ci_ui_tool_app module"
    - curl -L --fail "https://apihub.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-prod/prep/cdn/ci_ui_tool_bundle.js" -o "$BASE_DIR/fiserv_ci_ui_tool_app/js/ci_ui_tool_bundle.js"
    - echo "Downloading fiserv_cicd_app/js/cicd_uiapp_bundle.js into fiserv_cicd_app module"
    - curl -L --fail "https://apihub.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-prod/prep/cdn/cicd_uiapp_bundle.js" -o "$BASE_DIR/fiserv_cicd_app/js/cicd_uiapp_bundle.js"
    - echo "Downloading fiserv_general_pages/js/apihub_general.js into fiserv_general_pages module"
    - curl -L --fail "https://apihub.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-prod/prep/cdn/apihub_general.js" -o "$BASE_DIR/fiserv_general_pages/js/apihub_general.js"
    - echo "Downloading fiserv_general_pages/js/apihub_landing.js into fiserv_general_pages module"
    - curl -L --fail "https://apihub.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-prod/prep/cdn/apihub_landing.js" -o "$BASE_DIR/fiserv_general_pages/js/apihub_landing.js"
    - echo "Downloading fiserv_landing_page/js/apihub_landing.js into fiserv_landing_page module"
    - curl -L --fail "https://apihub.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-prod/prep/cdn/apihub_landing.js" -o "$BASE_DIR/fiserv_landing_page/js/apihub_landing.js"
    - echo "Downloading fiserv_monetization_app/js/monetization.js into fiserv_monetization_app module"
    - curl -L --fail "https://apihub.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-prod/prep/cdn/monetization.js" -o "$BASE_DIR/fiserv_monetization_app/js/monetization.js"
    - echo "Downloading fiserv_product_management_app/js/fiserv-admin-ui-product-app.js into fiserv_product_management_app module"
    - curl -L --fail "https://apihub.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-prod/prep/cdn/fiserv-admin-ui-product-app.js" -o "$BASE_DIR/fiserv_product_management_app/js/fiserv-admin-ui-product-app.js"
    - echo "Downloading fiserv_proxy_trace/js/proxy_trace_bundle.js into fiserv_proxy_trace module"
    - curl -L --fail "https://apihub.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-prod/prep/cdn/proxy_trace_bundle.js" -o "$BASE_DIR/fiserv_proxy_trace/js/proxy_trace_bundle.js"
    - echo "Downloading fiserv_cicd_app/js/config_admin_tool_bundle.js into fiserv_cicd_app module"
    - curl -L --fail "https://apihub.onefiserv.net/jsBundle?account=prodftsapihubgensa&path=/apihubstoragecontainer-prod/prep/cdn/config_admin_tool_bundle.js" -o "$BASE_DIR/fiserv_cicd_app/js/config_admin_tool_bundle.js"
    - echo "Downloading testing_tool_integration/testing_tool/static into testing_tool_integration module"
    - curl -L --fail "https://apihub-test.onefiserv.net/jsBundle?account=npftsapihubgensa&path=/apihubstoragecontainer/prep/cdn/static.zip" -o "$BASE_DIR/testing_tool_integration/testing_tool/static.zip"
    - unzip -o "$BASE_DIR/testing_tool_integration/testing_tool/static.zip" -d "$BASE_DIR/testing_tool_integration/testing_tool/"
    - rm "$BASE_DIR/testing_tool_integration/testing_tool/static.zip"

  artifacts:
    paths: 
      - web/modules/custom/
    expire_in: 1 hour


publish-develop:
  stage: image
  only:
    - develop
  script:
    - echo "Develop"
    - docker login -u $Nexus_REPO_USER -p $Nexus_REPO_PASS fmk.nexus-ci.onefiserv.net
    - docker build  . -t  $FMK_NEXUS/apihub-drupal:dev-$CI_COMMIT_SHORT_SHA
    - docker push $FMK_NEXUS/apihub-drupal:dev-$CI_COMMIT_SHORT_SHA
  environment:
    name: develop

publish-test:
  stage: image
  only:
    - test
  script:
    -  echo "Test"
    -  docker login -u $Nexus_REPO_USER -p $Nexus_REPO_PASS fmk.nexus-ci.onefiserv.net
    -  docker build  . -t  $FMK_NEXUS/apihub-drupal:test-$CI_COMMIT_SHORT_SHA
    -  docker push $FMK_NEXUS/apihub-drupal:test-$CI_COMMIT_SHORT_SHA
  environment:
    name: test

publish-cert:
  stage: image-cert
  only:
    - release
  script:
    -  echo "Cert"
    -  docker login -u $Nexus_REPO_USER -p $Nexus_REPO_PASS fmk.nexus-ci.onefiserv.net
    -  docker build  . -t  $FMK_NEXUS/apihub-drupal:cert-$CI_COMMIT_SHORT_SHA
    -  docker push $FMK_NEXUS/apihub-drupal:cert-$CI_COMMIT_SHORT_SHA
  environment:
    name: cert

publish-prod:
  stage: image-prod
  only:
    - release
  script:
    -  echo "Prod"
    -  docker login -u $Nexus_REPO_USER -p $Nexus_REPO_PASS fmk.nexus-ci.onefiserv.net
    -  docker build  . -t  $FMK_NEXUS/apihub-drupal:prod-$CI_COMMIT_SHORT_SHA
    -  docker push $FMK_NEXUS/apihub-drupal:prod-$CI_COMMIT_SHORT_SHA
  environment:
    name: prod
