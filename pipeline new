stages:
  - build
  - push

variables:
  IMAGE_NAME: "$CI_PROJECT_NAME"
  DOCKER_IMAGE_TAG: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
  NEXUS_REPO_URL: "nexus.example.com:8083"

build_python_image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u "$NEXUS_REPO_USER" -p "$NEXUS_REPO_PASS" $NEXUS_REPO_URL
  script:
    - echo "Checking for Python code changes..."
    - |
      if git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA | grep -E '\.py$'; then
        echo "Python code changed. Building image..."
        docker build -t $NEXUS_REPO_URL/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
      else
        echo "No Python code changes detected. Skipping build."
        exit 0
      fi
  artifacts:
    paths:
      - image.tag
    when: always

push_to_nexus:
  stage: push
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u "$NEXUS_REPO_USER" -p "$NEXUS_REPO_PASS" $NEXUS_REPO_URL
  script:
    - echo "Pushing image to Nexus..."
    - docker push $NEXUS_REPO_URL/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA
  rules:
    - changes:
        - "**/*.py"