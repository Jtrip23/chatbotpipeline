stages:
  - build
  - push

variables:
  IMAGE_NAME: "$CI_PROJECT_NAME"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  NEXUS_REPO_USER: "svc-apim-cicd-dev"
  NEXUS_REPO_PASS: "F_arX1Z%fIQSfZEM@aJL9RRk*"
  NEXUS_REGISTRY_URL: "fmk.nexus-ci.onefiserv.net/apm/006528"
  FULL_IMAGE_NAME: "$NEXUS_REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG"
  DOCKER_TLS_CERTDIR: ""

build_image:
  stage: build
  image: docker:latest
  services:
    - name: docker:dind
  before_script:
    - echo "$NEXUS_REPO_PASS" | docker login -u "$NEXUS_REPO_USER" --password-stdin $NEXUS_REGISTRY_URL
  script:
    - docker build -t $FULL_IMAGE_NAME .
  rules:
    - changes:
        - "**/*"

push_image:
  stage: push
  image: docker:latest
  services:
    - name: docker:dind
  before_script:
    - echo "$NEXUS_REPO_PASS" | docker login -u "$NEXUS_REPO_USER" --password-stdin $NEXUS_REGISTRY_URL
  script:
    - docker push $FULL_IMAGE_NAME
  rules:
    - changes:
        - "**/*"
