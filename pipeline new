stages:
  - build
  - push

variables:
  APM_ID: "0006528"
  IMAGE_NAME: "apihub-apigee-python"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  NEXUS_REGISTRY: "nexus-ci.nexus.onefiserv.net"
  NEXUS_REPO_PATH: "$NEXUS_REGISTRY/apm/$APM_ID/$IMAGE_NAME:$IMAGE_TAG"
  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""

build_python_image:
  stage: build
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
  before_script:
    - echo "$Nexus_REPO_PASS" | docker login -u "$Nexus_REPO_USER" --password-stdin $NEXUS_REGISTRY
  script:
    - |
      echo "Checking for Python file changes..."
      if git diff --name-only $CI_COMMIT_BEFORE_SHA $CI_COMMIT_SHA | grep -E '\.py$'; then
        echo "Python code changed. Building Docker image..."
        docker build -t $NEXUS_REPO_PATH .
      else
        echo "No Python code changes detected. Skipping build."
        exit 0
      fi

push_to_nexus:
  stage: push
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
  before_script:
    - echo "$Nexus_REPO_PASS" | docker login -u "$Nexus_REPO_USER" --password-stdin $NEXUS_REGISTRY
  script:
    - echo "Pushing Docker image to Nexus..."
    - docker push $NEXUS_REPO_PATH
  rules:
    - changes:
        - "**/*.py"