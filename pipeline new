stages:
  - build_and_push

variables:
  IMAGE_NAME: "$CI_PROJECT_NAME"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  NEXUS_REPO_USER: "svc-apim-cicd-dev"
  NEXUS_REPO_PASS: "F_arX1Z%fIQSfZEM@aJL9RRk*"
  NEXUS_REGISTRY: "fmk.nexus-ci.onefiserv.net"
  NEXUS_REPO_PATH: "apm/006528"
  FULL_IMAGE_NAME: "$NEXUS_REGISTRY/$NEXUS_REPO_PATH/$IMAGE_NAME:$IMAGE_TAG"

build_and_push_image:
  stage: build_and_push
  tags:
    - apihub-shell-prod
  only:
    - test
  script:
    - echo "Test"
    - echo "Logging into Nexus Docker registry..."
    - docker login -u "$NEXUS_REPO_USER" -p "$NEXUS_REPO_PASS" $NEXUS_REGISTRY

    - echo "Building Docker image..."
    - docker build . -t $FULL_IMAGE_NAME

    - echo "Pushing Docker image to Nexus..."
    - docker push $FULL_IMAGE_NAME

  environment:
    name: test