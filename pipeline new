variables:
  FMK_NEXUS: fmk.nexus-ci.onefiserv.net/apm/0007440
  IMAGE_NAME: "$CI_PROJECT_NAME"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"

default:
  tags:
    - apimhub-shell

stages:
  - build
  - push

build-image:
  stage: build
  script:
    - echo "Building Docker image..."
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker tag $IMAGE_NAME:$IMAGE_TAG $FMK_NEXUS/$IMAGE_NAME:$IMAGE_TAG
  rules:
    - changes:
        - Dockerfile
        - src/**/*
        - .gitlab-ci.yml

push-image:
  stage: push
  script:
    - echo "Logging into Nexus and pushing image..."
    - echo "$NEXUS_REPO_PASS_DEV" | docker login $FMK_NEXUS -u "$NEXUS_REPO_USER_DEV" --password-stdin
    - docker push $FMK_NEXUS/$IMAGE_NAME:$IMAGE_TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'