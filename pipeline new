variables:
  FMK_NEXUS: fmk.nexus-ci.onefiserv.net/apm/0007440

default:
  tags:
    - apimhub

stages:
  - build-and-push

build-and-push-image:
  stage: build-and-push
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "Checking Docker version"
    - docker --version
  script:
    - echo "Building Docker image for $CI_PROJECT_NAME"
    - IMAGE_NAME="$FMK_NEXUS/$DOCKER_IMAGE_NAME:${CI_COMMIT_SHORT_SHA}"
    - docker build -t "$IMAGE_NAME" .
    - echo "$NEXUS_REPO_PASS_DEV" | docker login -u "$NEXUS_REPO_USER_DEV" --password-stdin "$FMK_NEXUS"
    - docker push "$IMAGE_NAME"
  rules:
    - when: always